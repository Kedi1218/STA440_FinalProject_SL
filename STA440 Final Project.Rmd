---
title: "STA440 Final Project"
author: "Sophia Li"
date: "2024-12-15"
output: pdf_document
---

```{r}
# Using readr for better performance
library(readr)
suicide_data <- read_csv("SuicideChina.csv")

```
```{r}
# View first few rows
head(suicide_data)

# Check data structure
str(suicide_data)

# Summary statistics
summary(suicide_data)

```

Let's do some EDA first 


```{r}
# Frequency of 'Died'
table(suicide_data$Died)

# Frequency of 'Sex'
table(suicide_data$Sex)

# Frequency of 'Urban'
table(suicide_data$Urban)

# Frequency of 'Method'
table(suicide_data$method)

```

```{r}
# Summary of Age
summary(suicide_data$Age)

install.packages("ggplot2")
library(ggplot2)


ggplot(suicide_data, aes(x = Age)) +
  geom_histogram(binwidth = 5, fill = "blue", alpha = 0.7) +
  labs(title = "Age Distribution", x = "Age", y = "Count")
```

```{r}
ggplot(suicide_data, aes(x = Sex, fill = Died)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Deaths by Sex", x = "Sex", y = "Proportion", fill = "Died")
```

```{r}
ggplot(suicide_data, aes(x = method, fill = Died)) +
  geom_bar(position = "fill") +
  coord_flip() +
  labs(title = "Proportion of Deaths by Method", x = "Method", y = "Proportion", fill = "Died")

```

```{r}
ggplot(suicide_data, aes(x = Age, fill = Died)) +
  geom_density(alpha = 0.5) +
  labs(title = "Age Distribution by Outcome", x = "Age", y = "Density", fill = "Died")

```

```{r}
ggplot(suicide_data, aes(x = Sex, fill = method)) +
  geom_bar(position = "fill") +
  labs(title = "Method of Suicide by Sex", x = "Sex", y = "Proportion", fill = "Method")

```

```{r}
ggplot(suicide_data, aes(x = Age, fill = Died)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~Urban) +
  labs(title = "Age Distribution by Outcome and Urban/Rural", x = "Age", y = "Density", fill = "Died")


```

```{r}
ggplot(suicide_data, aes(x = Education, fill = Died)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Deaths by Education Level", x = "Education Level", y = "Proportion", fill = "Died")


```


```{r}

```

```{r}
# Interaction between Age and Gender on Death Outcome
ggplot(suicide_data, aes(x = Age, fill = Died)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~Sex) +
  labs(
    title = "Interaction Between Age and Gender on Death Outcome",
    x = "Age",
    y = "Density",
    fill = "Died"
  )


```
```{r}
ggplot(suicide_data, aes(x = Age, fill = Died)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~Year) +
  labs(
    title = "Age Distribution by Year and Death Outcome",
    x = "Age",
    y = "Density",
    fill = "Died"
  )
```
```{r}
library(ggplot2)

ggplot(suicide_data, aes(x = as.factor(Year), fill = Died)) +
  geom_bar(position = "fill") +
  labs(
    title = "Proportion of Deaths by Year",
    x = "Year",
    y = "Proportion",
    fill = "Died"
  )

```

```{r}
ggplot(suicide_data, aes(x = as.factor(Year), fill = Died)) +
  geom_bar() +
  labs(
    title = "Count of Deaths by Year",
    x = "Year",
    y = "Count",
    fill = "Died"
  )


```

```{r}
library(ggplot2)

ggplot(suicide_data, aes(x = as.factor(Month), fill = Died)) +
  geom_bar(position = "fill") +
  facet_wrap(~ Year) +
  labs(
    title = "Proportion of Deaths by Month Across Years",
    x = "Month",
    y = "Proportion",
    fill = "Died"
  ) +
  scale_x_discrete(labels = c("1" = "Jan", "2" = "Feb", "3" = "Mar", "4" = "Apr",
                              "5" = "May", "6" = "Jun", "7" = "Jul", "8" = "Aug",
                              "9" = "Sep", "10" = "Oct", "11" = "Nov", "12" = "Dec"))

```

```{r}
# Convert 'Died' to a factor variable
suicide_data$Died <- factor(suicide_data$Died, levels = c("no", "yes"))

# Fit logistic regression model
logistic_model <- glm(Died ~ Age + Sex + Education + Occupation + method + Urban + Year + Month, 
                      data = suicide_data, 
                      family = binomial)

# Summary of the model
summary(logistic_model)

# Odds Ratios
exp(coef(logistic_model))

```

```{r}
# Count the frequency of each occupation
occupation_counts <- table(suicide_data$Occupation)
print(occupation_counts)
```
```{r}
library(ggplot2)

# Create a stacked bar plot for Died and Hospitalised by Education
ggplot(suicide_data, aes(x = Education, fill = interaction(Died, Hospitalised))) +
  geom_bar(position = "fill") +
  labs(
    title = "Proportion of Death and Hospitalisation by Education Level",
    x = "Education Level",
    y = "Proportion",
    fill = "Died and Hospitalised"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
# Count the frequency of each occupation
educationlevels_counts <- table(suicide_data$Education)
print(educationlevels_counts)
```

```{r}
# Count the frequency of each occupation
month_counts <- table(suicide_data$Month)
print(month_counts)
```

```{r}
# Count the frequency of each occupation
age_counts <- table(suicide_data$Age)
print(age_counts)
```

```{r}
hos <- table(suicide_data$Hospitalised)
print(hos)
```

```{r}
urban <- table(suicide_data$Urban)
print(urban)
```


```{r}
# Filter dataset to include only farming and household occupations
suicide_data <- suicide_data %>%
  filter(Occupation %in% c("farming", "household"))
```


```{r}
library(dplyr)

# Filter for farming and household occupations and remove "unknown" values
cleaned_data <- suicide_data %>%
  filter(Occupation %in% c("farming", "household")) %>%   # Keep only farming and household
  filter(!Education %in% c("unknown"),                   # Remove "unknown" in Education
         !Died %in% c("unknown"),                        # Remove "unknown" in Died
         !Hospitalised %in% c("unknown"),                # Remove "unknown" in Hospitalised
         !method %in% c("unknown"),                      # Remove "unknown" in method
         !Urban %in% c("unknown"))                       # Remove "unknown" in Urban

# Check the size of the cleaned dataset
nrow(cleaned_data)
```

```{r}
# Combine 'Poison' and 'Poison unspecified' into a single category 'Poison'
cleaned_data <- cleaned_data %>%
  mutate(method = case_when(
    method %in% c("Poison", "Poison unspec", "Other poison") ~ "Poison",
    TRUE ~ method  # Keep other categories unchanged
  ))

# Check the updated counts for the 'method' column
table(cleaned_data$method)

```


```{r}
# Ensure 'Died' is a binary factor with levels "no" and "yes"
cleaned_data$Died <- factor(cleaned_data$Died, levels = c("no", "yes"))

# Build the logistic regression model
death_model <- glm(Died ~ Age + Sex + Education + method + Urban + Year + Month, 
                   data = cleaned_data, 
                   family = binomial)

# View model summary
summary(death_model)

# Calculate odds ratios for interpretation
exp(coef(death_model))

```

```{r}
# Create a new column 'Season' based on the month
cleaned_data <- cleaned_data %>%
  mutate(Season = case_when(
    Month %in% c(12, 1, 2) ~ "Winter",
    Month %in% c(3, 4, 5) ~ "Spring",
    Month %in% c(6, 7, 8) ~ "Summer",
    Month %in% c(9, 10, 11) ~ "Fall"
  ))

# Check the counts for each season
table(cleaned_data$Season)

```

```{r}
# Update the logistic regression model with 'Season' instead of 'Month'
death_model_season <- glm(Died ~ Age + Sex + Education + method + Urban + Year + Season, 
                          data = cleaned_data, 
                          family = binomial)

# View the model summary
summary(death_model_season)

# Calculate odds ratios for interpretation
exp(coef(death_model_season))
```

```{r}
# Convert Year into a categorical variable
cleaned_data$Year <- as.factor(cleaned_data$Year)

# Check the levels to confirm
levels(cleaned_data$Year)
```

```{r}
# Logistic regression with Year as a categorical variable
death_model_categorical <- glm(Died ~ Age + Sex + Education + method + Urban + Season + Year, 
                               data = cleaned_data, 
                               family = binomial)

# View model summary
summary(death_model_categorical)

# Calculate odds ratios
exp(coef(death_model_categorical))

```


```{r}
# Plot Age and Sex interaction
ggplot(cleaned_data, aes(x = Age, y = as.numeric(Died == "yes"), color = Sex)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial")) +
  labs(
    title = "Interaction Between Age and Sex on Death Outcome",
    x = "Age",
    y = "Probability of Death"
  )


```

```{r}

# Create a bar plot showing proportions
ggplot(cleaned_data, aes(x = Education, fill = Died)) +
  geom_bar(position = "fill") +
  facet_wrap(~ Urban) +
  labs(
    title = "Proportion of Deaths by Education Level and Urban/Rural",
    x = "Education Level",
    y = "Proportion",
    fill = "Died"
  )

```

```{r}
# Add Education and Urban interaction to the model
interaction_model <- glm(Died ~ Age + Education + Urban + method + Season + Year * Sex, 
                         data = cleaned_data, 
                         family = binomial)

# View the model summary
summary(interaction_model)

```

```{r}
library(pROC)
roc_curve <- roc(cleaned_data$Died, predict(death_model_categorical, type = "response"))
plot(roc_curve)
auc(roc_curve)


```